#!/usr/bin/env Rscript

## =========================================================
## KAT8 bulk RNA-seq: Tissue KAT8KD vs CTL
## iWAT & gWAT, F/M; FL vs AKO/MAKO
## Density (before/after), PCA, MDS, limma-voom,
## volcanos (viridis + standard thresholds, cells-style),
## per-contrast heatmaps, DEG counts
## (pathway analysis removed)
## WITH save_core / run management
## =========================================================

## 0) Working dir (optional) --------------------------------
## setwd("C:/Users/lking/OneDrive - Louisiana State University/PBRC/Bioinformatics/KAT8KD_RNAseq")

## 1) Packages ----------------------------------------------
required_pkgs <- c(
  "dplyr",
  "limma",
  "edgeR",
  "ggplot2",
  "RColorBrewer",
  "ggrepel",
  "viridis",
  "pheatmap",
  "grid"
)

to_install <- setdiff(required_pkgs, rownames(installed.packages()))
if (length(to_install) > 0) {
  install.packages(to_install, dependencies = TRUE)
}

suppressPackageStartupMessages({
  library(dplyr)
  library(limma)
  library(edgeR)
  library(ggplot2)
  library(RColorBrewer)
  library(ggrepel)
  library(viridis)
  library(pheatmap)
  library(grid)   ## for unit()
})

## 2) save_core utilities -----------------------------------

utils_dir <- file.path(getwd(), "save_core")
source(file.path(utils_dir, "save.R"))
source(file.path(utils_dir, "findsave.R"))
source(file.path(utils_dir, "purge.R"))
source(file.path(utils_dir, "dedupe.R"))

## 2.5) Run metadata ----------------------------------------

run_info <- list(
  script_name = "KAT8_bulk_tissue_KAT8KD.R",
  species     = "mouse",
  data_type   = "bulkRNAseq_WAT_tissue",
  keywords    = c("KAT8", "WAT", "iWAT", "gWAT", "bulk RNA-seq", "tissue"),
  notes       = "KAT8KD vs CTL in iWAT/gWAT, F/M; per-depot/sex contrasts",
  message     = "Tissue KAT8KD vs CTL: limma-voom + PCA/MDS + DEGs (pathway removed)"
)

## 3) init_run ----------------------------------------------

run_ctx <- init_run(
  script_name = run_info$script_name,
  species     = run_info$species,
  data_type   = run_info$data_type,
  keywords    = run_info$keywords,
  notes       = run_info$notes
)

outdir  <- run_ctx$outdir
run_tag <- run_ctx$run_tag

cat("Run directory:", normalizePath(outdir, mustWork = FALSE), "\n")

## 4) Main logic --------------------------------------------

hero_volcano_file <- NULL  ## holds one representative plot for save_core

tryCatch({

  ## 4.1) Load raw counts -----------------------------------

  cat("\n=== RAW COUNTS MATRIX (FULL) ===\n")

  counts_raw <- read.delim(
    "counts.txt",
    header           = TRUE,
    stringsAsFactors = FALSE,
    check.names      = FALSE
  )

  cat("Dimensions (rows x cols):", paste(dim(counts_raw), collapse = " x "), "\n")
  cat("First 10 column names:\n")
  print(head(colnames(counts_raw), 10))

  cat("\nHead of counts (first 5 rows, first 6 cols):\n")
  print(head(counts_raw[, 1:min(6, ncol(counts_raw))]))

  ## 4.2) Define tissue samples + annotation ----------------

  sample_ids <- paste0("JS_", sprintf("%02d", 1:40))

  sample_annot_full <- data.frame(
    Sample   = sample_ids,
    Depot    = c(
      rep("iWAT", 10),
      rep("iWAT", 10),
      rep("gWAT", 10),
      rep("gWAT", 10)
    ),
    Sex      = c(
      rep("F", 5),  rep("F", 5),   # iWAT F CTL / KAT8KD
      rep("M", 5),  rep("M", 5),   # iWAT M CTL / KAT8KD
      rep("F", 5),  rep("F", 5),   # gWAT F CTL / KAT8KD
      rep("M", 5),  rep("M", 5)    # gWAT M CTL / KAT8KD
    ),
    Genotype = c(
      rep("CTL",    5), rep("KAT8KD", 5),
      rep("CTL",    5), rep("KAT8KD", 5),
      rep("CTL",    5), rep("KAT8KD", 5),
      rep("CTL",    5), rep("KAT8KD", 5)
    ),
    stringsAsFactors = FALSE
  )

  ## Remove outlier samples at the annotation level
  outlier_samples <- c("JS_08", "JS_28")

  ## =========================================================
  ## 4.2.1) QC PLOTS BEFORE OUTLIER REMOVAL
  ## Evidence supporting outlier removal decision
  ## =========================================================

  cat("\n=== QC BEFORE OUTLIER REMOVAL ===\n")

  ## Get counts for ALL tissue samples (including outliers)
  all_tissue_samples <- sample_annot_full$Sample
  missing_all <- setdiff(all_tissue_samples, colnames(counts_raw))
  if (length(missing_all) > 0) {
    stop("Missing columns for QC: ", paste(missing_all, collapse = ", "))
  }

  counts_all_tissue <- as.matrix(counts_raw[, all_tissue_samples])
  rownames(counts_all_tissue) <- counts_raw$gene_id

  ## Create temp DGEList with ALL samples
  DGE_all <- DGEList(counts = counts_all_tissue)
  DGE_all <- calcNormFactors(DGE_all)

  ## Attach sample info
  DGE_all$samples$Sample   <- sample_annot_full$Sample
  DGE_all$samples$Depot    <- sample_annot_full$Depot
  DGE_all$samples$Sex      <- sample_annot_full$Sex
  DGE_all$samples$Genotype <- factor(sample_annot_full$Genotype,
                                      levels = c("CTL", "KAT8KD"))
  DGE_all$samples$DepotSex <- factor(
    paste(sample_annot_full$Depot, sample_annot_full$Sex, sep = "_"),
    levels = c("iWAT_F", "iWAT_M", "gWAT_F", "gWAT_M")
  )
  DGE_all$samples$IsOutlier <- DGE_all$samples$Sample %in% outlier_samples

  ## Compute logCPM for all samples (before gene filtering)
  logCPM_all <- cpm(DGE_all, log = TRUE, prior.count = 3)

  ## --- (a) Library Size Plot ---
  lib_sizes_all <- data.frame(
    Sample     = colnames(DGE_all$counts),
    LibSize    = DGE_all$samples$lib.size,
    DepotSex   = DGE_all$samples$DepotSex,
    Genotype   = DGE_all$samples$Genotype,
    IsOutlier  = DGE_all$samples$IsOutlier,
    stringsAsFactors = FALSE
  )
  lib_sizes_all$Sample <- factor(lib_sizes_all$Sample,
                                  levels = lib_sizes_all$Sample[order(lib_sizes_all$LibSize)])

  qc_libsize_plot <- ggplot(lib_sizes_all,
                             aes(x = Sample, y = LibSize / 1e6,
                                 fill = DepotSex, alpha = IsOutlier)) +
    geom_bar(stat = "identity", color = "black", linewidth = 0.3) +
    geom_text(
      data = lib_sizes_all[lib_sizes_all$IsOutlier, ],
      aes(label = Sample),
      vjust = -0.5, hjust = 0.5, size = 3, fontface = "bold", color = "red"
    ) +
    scale_fill_manual(
      values = c("iWAT_F" = "#1b9e77", "iWAT_M" = "#d95f02",
                 "gWAT_F" = "#7570b3", "gWAT_M" = "#e7298a"),
      name = "Depot/Sex"
    ) +
    scale_alpha_manual(values = c("FALSE" = 1, "TRUE" = 0.5),
                       name = "Outlier", labels = c("No", "Yes")) +
    labs(
      title    = "Library Sizes (Before Outlier Removal)",
      subtitle = paste0("Outliers highlighted: ", paste(outlier_samples, collapse = ", ")),
      x        = "Sample",
      y        = "Library Size (millions)"
    ) +
    theme_bw(base_size = 12) +
    theme(
      axis.text.x     = element_text(angle = 45, hjust = 1, size = 8),
      plot.title      = element_text(hjust = 0.5, face = "bold"),
      plot.subtitle   = element_text(hjust = 0.5, color = "red"),
      legend.position = "right"
    )

  libsize_file <- paste0("QC_library_size_before_outlier_removal_", run_tag, ".png")
  ggsave(
    file.path(outdir, "plots", libsize_file),
    plot   = qc_libsize_plot,
    width  = 12,
    height = 6,
    dpi    = 300
  )
  cat("Saved QC library size plot to ",
      file.path(outdir, "plots", libsize_file), "\n")

  ## --- (b) Sample-Sample Correlation Heatmap ---
  cor_mat <- cor(logCPM_all, method = "pearson")

  ## Annotation for heatmap
  annot_row_corr <- data.frame(
    DepotSex = DGE_all$samples$DepotSex,
    Genotype = DGE_all$samples$Genotype,
    Outlier  = ifelse(DGE_all$samples$IsOutlier, "Yes", "No")
  )
  rownames(annot_row_corr) <- colnames(DGE_all$counts)

  annot_colors_corr <- list(
    DepotSex = c("iWAT_F" = "#1b9e77", "iWAT_M" = "#d95f02",
                 "gWAT_F" = "#7570b3", "gWAT_M" = "#e7298a"),
    Genotype = c(CTL = "#1B9E77", KAT8KD = "#D95F02"),
    Outlier  = c(Yes = "red", No = "grey80")
  )

  corr_heatmap_file <- paste0("QC_sample_correlation_before_outlier_removal_", run_tag, ".png")
  png(file.path(outdir, "plots", corr_heatmap_file),
      width = 2400, height = 2200, res = 200)
  pheatmap(
    cor_mat,
    color             = colorRampPalette(c("navy", "white", "firebrick3"))(100),
    breaks            = seq(0.7, 1, length.out = 101),
    cluster_rows      = TRUE,
    cluster_cols      = TRUE,
    show_rownames     = TRUE,
    show_colnames     = TRUE,
    fontsize_row      = 8,
    fontsize_col      = 8,
    annotation_row    = annot_row_corr,
    annotation_col    = annot_row_corr,
    annotation_colors = annot_colors_corr,
    main              = paste0("Sample Correlation (logCPM, before outlier removal)\n",
                               "Outliers: ", paste(outlier_samples, collapse = ", "))
  )
  dev.off()
  cat("Saved QC sample correlation heatmap to ",
      file.path(outdir, "plots", corr_heatmap_file), "\n")

  ## --- (c) PCA Before Outlier Removal ---
  pca_all <- prcomp(t(logCPM_all), scale. = TRUE)
  pca_var_all <- summary(pca_all)$importance[2, 1:2] * 100

  pca_all_df <- data.frame(
    Sample    = colnames(DGE_all$counts),
    Genotype  = DGE_all$samples$Genotype,
    DepotSex  = DGE_all$samples$DepotSex,
    Depot     = DGE_all$samples$Depot,
    Sex       = DGE_all$samples$Sex,
    IsOutlier = DGE_all$samples$IsOutlier,
    PC1       = pca_all$x[, 1],
    PC2       = pca_all$x[, 2],
    stringsAsFactors = FALSE
  )

  qc_pca_plot <- ggplot(
    pca_all_df,
    aes(x = PC1, y = PC2,
        color = DepotSex,
        shape = Genotype,
        label = Sample)
  ) +
    geom_point(aes(size = IsOutlier), alpha = 0.85) +
    geom_point(
      data = pca_all_df[pca_all_df$IsOutlier, ],
      color = "red", shape = 1, size = 6, stroke = 2
    ) +
    geom_text_repel(
      data          = pca_all_df[pca_all_df$IsOutlier, ],
      aes(label     = Sample),
      color         = "red",
      size          = 4,
      fontface      = "bold",
      box.padding   = unit(0.5, "lines"),
      max.overlaps  = Inf
    ) +
    geom_text_repel(
      data          = pca_all_df[!pca_all_df$IsOutlier, ],
      aes(label     = Sample),
      size          = 2.5,
      color         = "gray30",
      max.overlaps  = 30
    ) +
    scale_color_manual(
      values = c("iWAT_F" = "#1b9e77", "iWAT_M" = "#d95f02",
                 "gWAT_F" = "#7570b3", "gWAT_M" = "#e7298a"),
      name = "Depot/Sex"
    ) +
    scale_shape_manual(
      values = c("CTL" = 16, "KAT8KD" = 17),
      name = "Genotype"
    ) +
    scale_size_manual(
      values = c("FALSE" = 3, "TRUE" = 4),
      guide = "none"
    ) +
    labs(
      title    = "PCA Before Outlier Removal",
      subtitle = paste0("Outliers circled in red: ", paste(outlier_samples, collapse = ", ")),
      x        = paste0("PC1 (", round(pca_var_all[1], 1), "%)"),
      y        = paste0("PC2 (", round(pca_var_all[2], 1), "%)")
    ) +
    theme_bw(base_size = 14) +
    theme(
      plot.title      = element_text(hjust = 0.5, face = "bold"),
      plot.subtitle   = element_text(hjust = 0.5, color = "red"),
      legend.position = "right"
    )

  pca_qc_file <- paste0("QC_PCA_before_outlier_removal_", run_tag, ".png")
  ggsave(
    file.path(outdir, "plots", pca_qc_file),
    plot   = qc_pca_plot,
    width  = 10,
    height = 8,
    dpi    = 300
  )
  cat("Saved QC PCA plot to ",
      file.path(outdir, "plots", pca_qc_file), "\n")

  ## --- (d) Outlier Rationale Log File ---
  outlier_log_file <- file.path(outdir, "logs", paste0("outliers_", run_tag, ".txt"))

  lib_summary <- summary(DGE_all$samples$lib.size)
  outlier_lib_sizes <- DGE_all$samples$lib.size[DGE_all$samples$IsOutlier]
  names(outlier_lib_sizes) <- DGE_all$samples$Sample[DGE_all$samples$IsOutlier]

  outlier_log_lines <- c(
    "=== Outlier Removal Rationale ===",
    paste0("Run tag: ", run_tag),
    paste0("Generated: ", Sys.time()),
    "",
    "--- Outlier Sample IDs ---",
    paste0("  ", paste(outlier_samples, collapse = ", ")),
    "",
    "--- Library Sizes (All Samples) ---",
    paste0("  Min:     ", format(lib_summary["Min."], big.mark = ",")),
    paste0("  1st Qu:  ", format(lib_summary["1st Qu."], big.mark = ",")),
    paste0("  Median:  ", format(lib_summary["Median"], big.mark = ",")),
    paste0("  Mean:    ", format(lib_summary["Mean"], big.mark = ",")),
    paste0("  3rd Qu:  ", format(lib_summary["3rd Qu."], big.mark = ",")),
    paste0("  Max:     ", format(lib_summary["Max."], big.mark = ",")),
    "",
    "--- Outlier Library Sizes ---",
    sapply(names(outlier_lib_sizes), function(s) {
      paste0("  ", s, ": ", format(outlier_lib_sizes[s], big.mark = ","))
    }),
    "",
    "--- Rationale ---",
    "  Flagged based on separation in PCA/MDS and/or low library size in QC plots.",
    "  See QC plots for visual evidence:",
    paste0("    - ", libsize_file),
    paste0("    - ", corr_heatmap_file),
    paste0("    - ", pca_qc_file)
  )
  writeLines(outlier_log_lines, con = outlier_log_file)
  cat("Saved outlier rationale log to ", outlier_log_file, "\n")

  cat("=== END QC BEFORE OUTLIER REMOVAL ===\n\n")

  ## =========================================================
  ## Continue with outlier removal
  ## =========================================================

  sample_annot <- sample_annot_full %>%
    dplyr::filter(!(Sample %in% outlier_samples))

  tissue_samples <- sample_annot$Sample

  ## Sanity check
  missing_tissue <- setdiff(tissue_samples, colnames(counts_raw))
  if (length(missing_tissue) > 0) {
    stop(
      "These tissue sample columns are missing in counts.txt: ",
      paste(missing_tissue, collapse = ", ")
    )
  }

  counts_tissue_raw <- counts_raw[, c("gene_id", "gene", tissue_samples)]

  cat("\n=== TISSUE SUBSET (with outliers removed) ===\n")
  cat("Dimensions (rows x cols):", paste(dim(counts_tissue_raw), collapse = " x "), "\n")
  cat("Column names:\n")
  print(colnames(counts_tissue_raw))

  ## 4.3) Gene cleaning -------------------------------------

  counts_tissue <- counts_tissue_raw %>%
    mutate(
      ensembl_gene_id = gene_id,
      gene_name       = gene
    )

  na_or_blank <- is.na(counts_tissue$gene_name) | counts_tissue$gene_name == ""
  counts_tissue$gene_name[na_or_blank] <- counts_tissue$ensembl_gene_id[na_or_blank]

  cat("\nAny NA in gene_name (tissue)?  ", any(is.na(counts_tissue$gene_name)), "\n")
  cat("Any blank gene_name (tissue)?  ", any(counts_tissue$gene_name == ""), "\n")
  cat("Any duplicated gene_name (tissue)?  ", any(duplicated(counts_tissue$gene_name)), "\n")

  dup_count_tissue <- sum(duplicated(counts_tissue$gene_name))
  cat("Number of duplicated gene_name entries (tissue): ", dup_count_tissue, "\n")

  if (dup_count_tissue > 0) {
    cat("Renaming duplicated gene_name entries as ensembl_gene_id_gene_name (tissue).\n")

    dup_flag <- duplicated(counts_tissue$gene_name) |
      duplicated(counts_tissue$gene_name, fromLast = TRUE)

    counts_tissue$gene_name[dup_flag] <- paste0(
      counts_tissue$ensembl_gene_id[dup_flag],
      "_",
      counts_tissue$gene_name[dup_flag]
    )
  }

  rownames(counts_tissue) <- counts_tissue$gene_name

  cat("\n=== AFTER GENE CLEANING (TISSUE) ===\n")
  cat("Dimensions (rows x cols):", paste(dim(counts_tissue), collapse = " x "), "\n")

  ## 4.4) DGEList construction ------------------------------

  count_matrix_tissue <- as.matrix(counts_tissue[, tissue_samples])
  rownames(count_matrix_tissue) <- counts_tissue$gene_name

  DGE_tissue <- DGEList(counts = count_matrix_tissue)

  DGE_tissue$genes <- data.frame(
    gene_name       = rownames(DGE_tissue$counts),
    ensembl_gene_id = counts_tissue$ensembl_gene_id[
      match(rownames(DGE_tissue$counts), counts_tissue$gene_name)
    ],
    stringsAsFactors = FALSE
  )

  ## 4.5) Attach sample annotation --------------------------

  sample_annot <- sample_annot[match(colnames(DGE_tissue$counts),
                                     sample_annot$Sample), ]

  DGE_tissue$samples$Sample   <- sample_annot$Sample
  DGE_tissue$samples$Depot    <- sample_annot$Depot
  DGE_tissue$samples$Sex      <- sample_annot$Sex
  DGE_tissue$samples$Genotype <- factor(sample_annot$Genotype,
                                        levels = c("CTL", "KAT8KD"))

  DGE_tissue$samples$DepotSex <- factor(
    paste(DGE_tissue$samples$Depot, DGE_tissue$samples$Sex, sep = "_"),
    levels = c("iWAT_F", "iWAT_M", "gWAT_F", "gWAT_M")
  )

  DGE_tissue$samples$GroupFull <- factor(
    paste(DGE_tissue$samples$Depot,
          DGE_tissue$samples$Sex,
          DGE_tissue$samples$Genotype,
          sep = "_"),
    levels = c(
      "iWAT_F_CTL",   "iWAT_F_KAT8KD",
      "iWAT_M_CTL",   "iWAT_M_KAT8KD",
      "gWAT_F_CTL",   "gWAT_F_KAT8KD",
      "gWAT_M_CTL",   "gWAT_M_KAT8KD"
    )
  )

  rownames(DGE_tissue$samples) <- colnames(DGE_tissue$counts)

  cat("\nSample annotation head:\n")
  print(head(DGE_tissue$samples))

  cat("\n=== DGE BASIC QC (TISSUE) ===\n")
  cat("Number of genes:   ", nrow(DGE_tissue$counts), "\n")
  cat("Number of samples: ", ncol(DGE_tissue$counts), "\n")
  cat("Library sizes:\n")
  print(DGE_tissue$samples$lib.size)
  cat("\nSummary of library sizes:\n")
  print(summary(DGE_tissue$samples$lib.size))

  ## 4.6) TMM normalization + filtering ---------------------

  DGE_tissue <- calcNormFactors(DGE_tissue)

  n_tissue <- ncol(DGE_tissue$counts)

  logCPM_tissue <- cpm(DGE_tissue, log = TRUE, prior.count = 3)

  keep_tissue <- rowSums(cpm(DGE_tissue) > 1) >= (n_tissue / 2)

  cat("\nNumber of genes before CPM filter (tissue): ", length(keep_tissue), "\n")
  cat("Number of genes passing CPM filter  (tissue): ", sum(keep_tissue), "\n")

  DGE_tissue_filt <- DGE_tissue[keep_tissue, , keep.lib.sizes = FALSE]

  cat("Number of genes after filtering (tissue): ",
      nrow(DGE_tissue_filt$counts), "\n")

  logCPM_tissue_filt <- cpm(DGE_tissue_filt, log = TRUE, prior.count = 3)

  ## 4.7) Density plots (before/after filter) ---------------

  plot_density_tissue <- function() {

    ## Compute density objects for all samples first
    dens_before <- apply(logCPM_tissue,      2, density)
    dens_after  <- apply(logCPM_tissue_filt, 2, density)

    ## Compute global xlim from density objects (covers all curves)
    xlim_before <- range(sapply(dens_before, function(d) range(d$x)))
    xlim_after  <- range(sapply(dens_after,  function(d) range(d$x)))
    ## Use global xlim across both plots for comparability
    xlim_global <- range(c(xlim_before, xlim_after))

    ## Compute ylim from density objects
    max_y_before <- max(sapply(dens_before, function(d) max(d$y)))
    max_y_after  <- max(sapply(dens_after,  function(d) max(d$y)))

    ## Increased margins: bottom, left, top, right (extra top for subtitle)
    par(mfrow = c(1, 2), mar = c(5, 5, 5, 2), oma = c(0, 0, 2, 0))
    par(xpd = FALSE)

    cols_before <- viridis(ncol(logCPM_tissue), option = "D", end = 0.95)
    cols_after  <- viridis(ncol(logCPM_tissue_filt), option = "D", end = 0.95)

    ## BEFORE filter
    plot(dens_before[[1]],
         main = "Tissue: log2 CPM (before filter)",
         sub  = paste0("Each line = one sample (n=", ncol(logCPM_tissue), ")"),
         xlab = "log2 CPM",
         lwd  = 2,
         col  = cols_before[1],
         xlim = xlim_global,
         ylim = c(0, max_y_before * 1.15))
    if (ncol(logCPM_tissue) > 1) {
      for (i in 2:ncol(logCPM_tissue)) {
        lines(dens_before[[i]], lwd = 2, col = cols_before[i])
      }
    }
    ## Legend removed; subtitle note added above

    ## AFTER filter
    plot(dens_after[[1]],
         main = "Tissue: log2 CPM (after filter)",
         sub  = paste0("Each line = one sample (n=", ncol(logCPM_tissue_filt), ")"),
         xlab = "log2 CPM",
         lwd  = 2,
         col  = cols_after[1],
         xlim = xlim_global,
         ylim = c(0, max_y_after * 1.15))
    if (ncol(logCPM_tissue_filt) > 1) {
      for (i in 2:ncol(logCPM_tissue_filt)) {
        lines(dens_after[[i]], lwd = 2, col = cols_after[i])
      }
    }
    ## Legend removed; subtitle note added above
  }

  density_file_tissue <- paste0("logCPM_density_KAT8KD_tissue_before_after_", run_tag, ".png")
  png(file.path(outdir, "plots", density_file_tissue),
      width = 1600, height = 900, res = 150)
  plot_density_tissue()
  dev.off()

  cat("\nSaved density plots to ",
      file.path(outdir, "plots", density_file_tissue), "\n")

  ## 4.8) PCA -----------------------------------------------

  pca_tissue <- prcomp(t(logCPM_tissue_filt), scale. = TRUE)
  pca_var_tissue <- summary(pca_tissue)$importance[2, 1:2] * 100

  pca_tissue_df <- data.frame(
    Sample   = colnames(DGE_tissue_filt$counts),
    Genotype = DGE_tissue_filt$samples$Genotype,
    DepotSex = DGE_tissue_filt$samples$DepotSex,
    Depot    = DGE_tissue_filt$samples$Depot,
    Sex      = DGE_tissue_filt$samples$Sex,
    PC1      = pca_tissue$x[, 1],
    PC2      = pca_tissue$x[, 2],
    stringsAsFactors = FALSE
  )

  p_tissue <- ggplot(
    pca_tissue_df,
    aes(x = PC1, y = PC2,
        color = DepotSex,
        shape = Genotype,
        label = Sample)
  ) +
    geom_point(size = 3) +
    geom_text_repel(size = 3, max.overlaps = 60) +
    scale_color_manual(
      values = c(
        "iWAT_F" = "#1b9e77",
        "iWAT_M" = "#d95f02",
        "gWAT_F" = "#7570b3",
        "gWAT_M" = "#e7298a"
      ),
      name = "Depot/Sex"
    ) +
    scale_shape_manual(
      values = c("CTL" = 16, "KAT8KD" = 17),
      name = "Genotype"
    ) +
    labs(
      title = "Tissue PCA (log2 CPM, filtered)",
      x = paste0("PC1 (", round(pca_var_tissue[1], 1), "%)"),
      y = paste0("PC2 (", round(pca_var_tissue[2], 1), "%)")
    ) +
    theme_bw(base_size = 14) +
    theme(
      plot.title      = element_text(hjust = 0.5, face = "bold"),
      legend.position = "right"
    )

  pca_file_tissue <- paste0("PCA_KAT8KD_tissue_PC1_PC2_", run_tag, ".png")
  ggsave(
    file.path(outdir, "plots", pca_file_tissue),
    plot   = p_tissue,
    width  = 8,
    height = 6,
    dpi    = 300
  )

  cat("Saved PCA plot to ",
      file.path(outdir, "plots", pca_file_tissue), "\n")

  ## 4.9) MDS -----------------------------------------------

  dist_mat <- dist(t(logCPM_tissue_filt))
  mds_coords <- cmdscale(dist_mat, k = 2)
  mds_df <- data.frame(
    Sample   = colnames(DGE_tissue_filt$counts),
    Genotype = DGE_tissue_filt$samples$Genotype,
    DepotSex = DGE_tissue_filt$samples$DepotSex,
    Depot    = DGE_tissue_filt$samples$Depot,
    Sex      = DGE_tissue_filt$samples$Sex,
    MDS1     = mds_coords[, 1],
    MDS2     = mds_coords[, 2],
    stringsAsFactors = FALSE
  )

  mds_plot <- ggplot(
    mds_df,
    aes(x = MDS1, y = MDS2,
        color = DepotSex,
        shape = Genotype,
        label = Sample)
  ) +
    geom_point(size = 3) +
    geom_text_repel(size = 3, max.overlaps = 60) +
    scale_color_manual(
      values = c(
        "iWAT_F" = "#1b9e77",
        "iWAT_M" = "#d95f02",
        "gWAT_F" = "#7570b3",
        "gWAT_M" = "#e7298a"
      ),
      name = "Depot/Sex"
    ) +
    scale_shape_manual(
      values = c("CTL" = 16, "KAT8KD" = 17),
      name = "Genotype"
    ) +
    labs(
      title = "Tissue MDS (log2 CPM, filtered)",
      x = "MDS1",
      y = "MDS2"
    ) +
    theme_bw(base_size = 14) +
    theme(
      plot.title      = element_text(hjust = 0.5, face = "bold"),
      legend.position = "right"
    )

  mds_file_tissue <- paste0("MDS_KAT8KD_tissue_", run_tag, ".png")
  ggsave(
    file.path(outdir, "plots", mds_file_tissue),
    plot   = mds_plot,
    width  = 8,
    height = 6,
    dpi    = 300
  )

  cat("Saved MDS plot to ",
      file.path(outdir, "plots", mds_file_tissue), "\n")

  ## 4.10) Design matrix + voom -----------------------------

  design_tissue <- model.matrix(~ 0 + DGE_tissue_filt$samples$GroupFull)
  colnames(design_tissue) <- levels(DGE_tissue_filt$samples$GroupFull)

  cat("\nDesign matrix (first rows):\n")
  print(head(design_tissue))

  v_tissue   <- voom(DGE_tissue_filt, design_tissue, plot = FALSE)
  fit_tissue <- lmFit(v_tissue, design_tissue)

  ## 4.11) Define contrasts ---------------------------------

  cont_tissue <- makeContrasts(
    iWAT_F_KD_vs_CTL = iWAT_F_KAT8KD - iWAT_F_CTL,
    iWAT_M_KD_vs_CTL = iWAT_M_KAT8KD - iWAT_M_CTL,
    gWAT_F_KD_vs_CTL = gWAT_F_KAT8KD - gWAT_F_CTL,
    gWAT_M_KD_vs_CTL = gWAT_M_KAT8KD - gWAT_M_CTL,
    levels = design_tissue
  )

  contrast_names <- colnames(cont_tissue)

  ## 4.12) DE thresholds (match cells script) ---------------

  logFC_cut_tissue <- 1
  fdr_cut_tissue   <- 0.05

  ## 4.12.1) Params list (centralized parameters) -----------

  params <- list(
    outlier_samples   = outlier_samples,
    cpm_filter        = list(
      min_cpm         = 1,
      min_samples_frac = 0.5,
      description     = "Keep genes with CPM > 1 in at least 50% of samples"
    ),
    prior_count       = 3,
    de_thresholds     = list(
      logFC_cutoff    = logFC_cut_tissue,
      fdr_cutoff      = fdr_cut_tissue
    ),
    volcano_labels    = list(
      top_n_by_fdr    = 10,
      top_n_by_fc     = 10
    ),
    heatmap_max_genes = 300
  )

  ## Save params to log file
  params_file <- file.path(outdir, "logs", paste0("params_", run_tag, ".txt"))
  params_lines <- c(
    "=== RNA-seq Pipeline Parameters ===",
    paste0("Run tag: ", run_tag),
    paste0("Generated: ", Sys.time()),
    "",
    "--- Outlier Samples ---",
    paste0("  IDs: ", paste(params$outlier_samples, collapse = ", ")),
    "",
    "--- CPM Filter Rule ---",
    paste0("  Minimum CPM: ", params$cpm_filter$min_cpm),
    paste0("  Minimum samples fraction: ", params$cpm_filter$min_samples_frac),
    paste0("  Description: ", params$cpm_filter$description),
    "",
    "--- logCPM Calculation ---",
    paste0("  prior.count: ", params$prior_count),
    "",
    "--- DE Thresholds ---",
    paste0("  logFC cutoff: ", params$de_thresholds$logFC_cutoff),
    paste0("  FDR cutoff: ", params$de_thresholds$fdr_cutoff),
    "",
    "--- Volcano Plot Labels ---",
    paste0("  Top N by FDR (per direction): ", params$volcano_labels$top_n_by_fdr),
    paste0("  Top N by |logFC| (per direction): ", params$volcano_labels$top_n_by_fc),
    "",
    "--- Heatmap ---",
    paste0("  Max genes displayed: ", params$heatmap_max_genes)
  )
  writeLines(params_lines, con = params_file)
  cat("Saved params to ", params_file, "\n")

  ## 4.13) Container for DE summary -------------------------

  deg_summary <- data.frame(
    Contrast              = contrast_names,
    N_DEG_FDR_lt_0_05     = NA_integer_,
    stringsAsFactors      = FALSE
  )

  ## store per-contrast DE tables (gene-level only)
  tt_list <- vector("list", length(contrast_names))
  names(tt_list) <- contrast_names

  ## 4.14) Loop over contrasts: DE, volcano, heatmap --------

  for (cn in contrast_names) {

    cat("\n=== Contrast: ", cn, " ===\n", sep = "")

    ## ---- DE fit + table -----------------------------------
    fit2 <- contrasts.fit(fit_tissue, cont_tissue[, cn, drop = FALSE])
    fit2 <- eBayes(fit2)

    tt <- topTable(
      fit2,
      coef    = 1,
      n       = Inf,
      sort.by = "P"
    )

    if (!"gene_name" %in% colnames(tt)) {
      tt$gene_name <- rownames(tt)
    }

    ## store for later reference (gene-level only)
    tt_list[[cn]] <- tt

    de_file <- paste0("DE_tissue_", cn, "_", run_tag, ".csv")
    write.csv(
      tt,
      file      = file.path(outdir, "tables", de_file),
      row.names = TRUE
    )

    n_sig <- sum(tt$adj.P.Val < fdr_cut_tissue, na.rm = TRUE)
    cat("DE table written: ",
        file.path(outdir, "tables", de_file), "\n", sep = "")
    cat("Number of genes with FDR < 0.05 (", cn, "): ",
        n_sig, "\n", sep = "")

    deg_summary$N_DEG_FDR_lt_0_05[deg_summary$Contrast == cn] <- n_sig

    ## ---- Volcano plot (viridis + FDR + |FC| labels) -------

    tt_plot <- tt %>%
      dplyr::filter(
        is.finite(logFC),
        is.finite(adj.P.Val),
        adj.P.Val > 0
      ) %>%
      mutate(
        negLogFDR = -log10(adj.P.Val)
      )

    logFC_cut <- logFC_cut_tissue
    fdr_cut   <- fdr_cut_tissue

    tt_plot <- tt_plot %>%
      mutate(
        sig_cat = dplyr::case_when(
          adj.P.Val < fdr_cut & logFC >=  logFC_cut  ~ "Up",
          adj.P.Val < fdr_cut & logFC <= -logFC_cut  ~ "Down",
          TRUE                                       ~ "NS"
        ),
        sig_cat = factor(sig_cat, levels = c("Up", "Down", "NS"))
      )

    ## Filter to significant DEs for label selection
    tt_sig <- tt_plot %>%
      dplyr::filter(
        adj.P.Val < fdr_cut,
        abs(logFC) >= logFC_cut,
        sig_cat != "NS"
      )

    top_n_fdr <- 10  ## per direction by FDR
    top_n_fc  <- 10  ## per direction by |logFC|

    ## --- Upregulated ---
    up_sig <- tt_sig %>% dplyr::filter(sig_cat == "Up")

    up_top_fdr <- up_sig %>%
      dplyr::arrange(adj.P.Val) %>%
      dplyr::slice_head(n = top_n_fdr)

    up_top_fc <- up_sig %>%
      dplyr::arrange(dplyr::desc(logFC)) %>%
      dplyr::slice_head(n = top_n_fc)

    ## --- Downregulated ---
    down_sig <- tt_sig %>% dplyr::filter(sig_cat == "Down")

    down_top_fdr <- down_sig %>%
      dplyr::arrange(adj.P.Val) %>%
      dplyr::slice_head(n = top_n_fdr)

    down_top_fc <- down_sig %>%
      dplyr::arrange(logFC) %>%  ## most negative first
      dplyr::slice_head(n = top_n_fc)

    ## combine and dedupe
    label_genes <- dplyr::bind_rows(
      up_top_fdr,
      up_top_fc,
      down_top_fdr,
      down_top_fc
    ) %>%
      dplyr::distinct(gene_name, .keep_all = TRUE)

    vol_tissue <- ggplot(
      tt_plot,
      aes(
        x     = logFC,
        y     = negLogFDR,
        color = negLogFDR,
        shape = sig_cat
      )
    ) +
      geom_point(size = 2, alpha = 0.9) +
      scale_color_viridis(
        option    = "rocket",
        direction = 1,
        name      = "-log10(FDR)"
      ) +
      scale_shape_manual(
        values = c(
          "Up"   = 17,  # triangle up
          "Down" = 25,  # filled triangle down
          "NS"   = 16   # circle
        ),
        name = "Direction"
      ) +
      geom_point(
        data = label_genes,
        size = 2.8
      ) +
      geom_text_repel(
        data          = label_genes,
        aes(label     = gene_name),
        color         = "black",
        size          = 3.5,
        box.padding   = unit(0.25, "lines"),
        segment.color = "gray25",
        segment.size  = 0.25,
        point.padding = unit(0.2, "lines"),
        max.overlaps  = Inf
      ) +
      geom_hline(yintercept = -log10(fdr_cut), linetype = "dashed") +
      geom_vline(xintercept = c(logFC_cut, -logFC_cut), linetype = "dashed") +
      theme_bw(base_size = 14) +
      theme(
        panel.grid      = element_blank(),
        axis.text       = element_text(size = 10, face = "bold", colour = "black"),
        axis.title      = element_text(size = 16, face = "bold", colour = "black"),
        strip.text      = element_text(size = 10, face = "bold", colour = "black"),
        plot.title      = element_text(face = "bold", hjust = 0.5),
        legend.position = "bottom"
      ) +
      ggtitle(paste0("Volcano: ", cn, " (WAT tissue)")) +
      xlab(paste0("log2FC (", cn, ")")) +
      ylab("-log10 FDR")

    volcano_file <- paste0("Volcano_tissue_", cn, "_", run_tag, ".png")
    ggsave(
      file.path(outdir, "plots", volcano_file),
      plot   = vol_tissue,
      width  = 8,
      height = 6,
      dpi    = 300
    )

    cat("Volcano saved: ",
        file.path(outdir, "plots", volcano_file), "\n", sep = "")

    if (is.null(hero_volcano_file)) {
      hero_volcano_file <- volcano_file
    }

    ## ---- Heatmap of strongest DEGs ------------------------

    de_sig <- tt %>%
      dplyr::filter(adj.P.Val < fdr_cut_tissue,
                    abs(logFC) > logFC_cut_tissue)

    if (nrow(de_sig) >= 2) {

      de_sig <- de_sig[order(de_sig$adj.P.Val), , drop = FALSE]
      if (nrow(de_sig) > 300) {
        de_sig <- de_sig[1:300, , drop = FALSE]
      }
      gene_set <- rownames(de_sig)

      depot <- NA_character_
      sex   <- NA_character_
      if (grepl("^iWAT_F", cn)) {
        depot <- "iWAT"; sex <- "F"
      } else if (grepl("^iWAT_M", cn)) {
        depot <- "iWAT"; sex <- "M"
      } else if (grepl("^gWAT_F", cn)) {
        depot <- "gWAT"; sex <- "F"
      } else if (grepl("^gWAT_M", cn)) {
        depot <- "gWAT"; sex <- "M"
      }

      if (!is.na(depot) && !is.na(sex)) {

        idx_samples <- with(DGE_tissue_filt$samples,
                            Depot == depot & Sex == sex)
        samples_heat <- rownames(DGE_tissue_filt$samples)[idx_samples]

        mat <- logCPM_tissue_filt[gene_set, samples_heat, drop = FALSE]

        palette_hm <- colorRampPalette(c("blue", "white", "red"))(100)

        annot_col <- data.frame(
          Genotype = DGE_tissue_filt$samples$Genotype[idx_samples],
          Depot    = DGE_tissue_filt$samples$Depot[idx_samples],
          Sex      = DGE_tissue_filt$samples$Sex[idx_samples]
        )
        rownames(annot_col) <- samples_heat

        annot_colors <- list(
          Genotype = c(CTL = "#1B9E77", KAT8KD = "#D95F02"),
          Depot    = c(iWAT = "#377eb8", gWAT = "#e41a1c"),
          Sex      = c(F = "#984ea3", M = "#ff7f00")
        )

        heat_file <- paste0("Heatmap_tissue_", cn, "_", run_tag, ".png")
        png(file.path(outdir, "plots", heat_file),
            width = 3000, height = 3500, res = 300)
        pheatmap(
          mat,
          show_rownames     = TRUE,
          show_colnames     = TRUE,
          scale             = "row",
          cluster_cols      = FALSE,
          cluster_rows      = TRUE,
          color             = palette_hm,
          border_color      = NA,
          fontsize_row      = 6,
          fontsize_col      = 10,
          annotation_col    = annot_col,
          annotation_colors = annot_colors,
          annotation_legend = TRUE,
          main              = paste0("Top DEGs ", cn,
                                     " (FDR<0.05, |logFC|>", logFC_cut_tissue, ")")
        )
        dev.off()
        cat("Heatmap saved: ",
            file.path(outdir, "plots", heat_file), "\n", sep = "")

      } else {
        cat("Could not map contrast ", cn, " to depot/sex for heatmap.\n", sep = "")
      }
    } else {
      cat("Not enough DE genes for heatmap (", cn, ").\n", sep = "")
    }

  } ## end contrast loop

  ## 4.15) DEG summary table -------------------------------

  deg_summary_file <- paste0("DEG_summary_tissue_", run_tag, ".csv")
  write.csv(
    deg_summary,
    file = file.path(outdir, "tables", deg_summary_file),
    row.names = FALSE
  )
  cat("\nDEG summary written: ",
      file.path(outdir, "tables", deg_summary_file), "\n", sep = "")

  ## 4.16) save_core bookkeeping ----------------------------

  ## Save a representative plot (optional)
  if (!is.null(hero_volcano_file)) {
    hero_path <- file.path(outdir, "plots", hero_volcano_file)
    if (file.exists(hero_path)) {
      save_run_file(hero_path, tag = "hero_volcano")
    }
  }

  ## Let save_core dedupe if your setup uses it
  ## (safe to call even if it does nothing in your implementation)
  try(dedupe(outdir), silent = TRUE)

  cat("\nDONE.\n")

}, error = function(e) {

  cat("\nERROR:\n")
  cat(conditionMessage(e), "\n")

  ## Optionally write error log into run folder
  err_file <- paste0("ERROR_", run_tag, ".txt")
  writeLines(
    c("Script error:", conditionMessage(e)),
    con = file.path(outdir, "logs", err_file)
  )

  stop(e)

})
